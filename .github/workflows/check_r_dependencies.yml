name: Check R dependencies

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '0 0 * * 0'
  workflow_run:
    workflows:
      - 'Run Tests'
    types:
      - completed
    branches:
      - 'main'
  push:
    branches:
      - 'dependencies/r/auto_update'

jobs:
  check-r-dependencies:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 1

    - name: Check for available updates
      run: |
        for REQUIREMENTS in $(ls -1 docker/*/r_requirements.txt); do
          IMAGE=$(echo ${REQUIREMENTS} | sed 's:^docker/::' | sed 's:/.*::')
          docker pull -q singlecellopenproblems/${IMAGE}
          docker run -t --rm --user=root singlecellopenproblems/${IMAGE} \
            Rscript /usr/src/singlecellopenproblems/scripts/upgrade_renv.R \
            /usr/src/singlecellopenproblems/${REQUIREMENTS}
        done
        PKG_CHANGED=$(\
          git diff HEAD~1 | \
          grep --color=none "^+[a-z]" | \
          tail -n 1 | \
          sed 's/^+//'
        )
        echo "PKG_CHANGED=$(echo ${PKG_CHANGED} | sed 's/@/ to /')" >> $GITHUB_ENV
        echo "UPDATE_BRANCH_NAME=dependencies/r/${PKG_CHANGED}" >> $GITHUB_ENV

    - name: Commit result
      uses: EndBug/add-and-commit@v9
      with:
        author_name: dependabot[bot]
        author_email: singlecellopenproblems@protonmail.com
        message: "Update ${{ env.PKGS_CHANGED }}"
        add: "['docker']"
        new_branch: ${{ env.UPDATE_BRANCH_NAME }}
        push: true

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3
      with:
        branch: ${{ env.UPDATE_BRANCH_NAME }}
        delete-branch: true
        base: main
        title: "Update ${{ env.PKGS_CHANGED }}"
